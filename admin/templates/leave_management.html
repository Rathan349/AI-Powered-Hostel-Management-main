<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Leave Management</title>
  <link rel="stylesheet" href="{{ url_for('auth.static', filename='styles.css') }}">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;500;700&display=swap" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
  <style>
    .leave-header {
      background: linear-gradient(135deg, #ffc107, #e0a800);
      color: #212529;
      padding: 2rem;
      border-radius: 20px;
      margin-bottom: 2rem;
    }

    .issue-form {
      background: white;
      border-radius: 20px;
      padding: 2rem;
      box-shadow: 0 10px 30px rgba(0,0,0,0.1);
      margin-bottom: 2rem;
    }

    .leaves-list {
      background: white;
      border-radius: 20px;
      padding: 2rem;
      box-shadow: 0 5px 15px rgba(0,0,0,0.1);
    }

    .leave-card {
      background: #f8f9fa;
      border-radius: 15px;
      padding: 1.5rem;
      margin-bottom: 1rem;
      border-left: 5px solid #ffc107;
      transition: all 0.3s ease;
    }

    .leave-card:hover {
      transform: translateX(5px);
      box-shadow: 0 5px 15px rgba(0,0,0,0.1);
    }

    .leave-card.active {
      border-left-color: #28a745;
      background: #e8f5e9;
    }

    .leave-card.returned {
      border-left-color: #6c757d;
      background: #f1f3f4;
    }

    .leave-header-info {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1rem;
    }

    .leave-title {
      font-weight: 600;
      color: #1d3557;
      font-size: 1.1rem;
    }

    .status-badge {
      padding: 0.4rem 0.8rem;
      border-radius: 20px;
      font-size: 0.8rem;
      font-weight: 600;
      text-transform: uppercase;
    }

    .status-active {
      background: #d1edff;
      color: #0c5460;
    }

    .status-returned {
      background: #d4edda;
      color: #155724;
    }

    .status-expired {
      background: #f8d7da;
      color: #721c24;
    }

    .status-pending {
      background: #fff3cd;
      color: #856404;
    }

    .status-rejected {
      background: #f8d7da;
      color: #721c24;
    }

    .status-approved {
      background: #d4edda;
      color: #155724;
    }

    .leave-details {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 1rem;
      font-size: 0.9rem;
      color: #666;
    }

    .detail-item {
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .form-control {
      border: 2px solid #e9ecef;
      border-radius: 10px;
      padding: 0.75rem;
    }

    .form-control:focus {
      border-color: #ffc107;
      box-shadow: 0 0 0 0.2rem rgba(255,193,7,.25);
    }

    .btn-issue {
      background: linear-gradient(135deg, #ffc107, #e0a800);
      border: none;
      padding: 1rem 2rem;
      border-radius: 12px;
      color: #212529;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      width: 100%;
    }

    .btn-issue:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(255,193,7,0.4);
    }

    .qr-modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.8);
      z-index: 1000;
      justify-content: center;
      align-items: center;
    }

    .qr-modal.show {
      display: flex;
    }

    .qr-content {
      background: white;
      border-radius: 20px;
      padding: 2rem;
      max-width: 500px;
      width: 90%;
      position: relative;
    }

    .qr-close {
      position: absolute;
      top: 1rem;
      right: 1rem;
      background: #dc3545;
      color: white;
      border: none;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      cursor: pointer;
    }

    .qr-code-img {
      max-width: 250px;
      width: 100%;
      border: 3px solid #ffc107;
      border-radius: 15px;
      padding: 1rem;
      margin: 0 auto 1rem;
      display: block;
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- Sidebar -->
    <aside class="sidebar">
      <div class="logo">
        <h2>üè® Hostel Manager</h2>
      </div>
      <nav class="nav-links">
        <a href="{{url_for('dashboard.mainpage')}}">üè† Dashboard</a>
        <a href="{{url_for('qr.digital_documents')}}">üì± Digital Documents</a>
        <a href="{{url_for('qr.student_id_generator')}}">üÜî Student IDs</a>
        <a href="{{url_for('qr.visitor_management')}}">üë• Visitors</a>
        <a href="{{url_for('qr.leave_management')}}" class="active">‚úàÔ∏è Leave Passes</a>
        <a href="{{url_for('auth.logout')}}">üö™ Logout</a>
      </nav>
    </aside>

    <!-- Main Content -->
    <main class="main-content">
      <!-- Header -->
      <div class="leave-header">
        <h1 class="mb-3">‚úàÔ∏è Digital Leave Pass Management</h1>
        <p class="mb-0">Issue and manage digital leave passes with QR verification</p>
      </div>

      <!-- Info Section -->
      <div class="issue-form">
        <h3 class="mb-4">‚ÑπÔ∏è Leave Request Management</h3>
        <div class="alert alert-info">
          <h5><i class="fas fa-info-circle"></i> How it works:</h5>
          <ol class="mb-0">
            <li><strong>Students submit</strong> leave requests through their dashboard</li>
            <li><strong>You review</strong> pending requests below</li>
            <li><strong>Approve or reject</strong> requests with one click</li>
            <li><strong>QR codes are generated</strong> automatically upon approval</li>
            <li><strong>Students receive</strong> their digital leave passes instantly</li>
          </ol>
        </div>
      </div>

      <!-- Pending Leave Requests -->
      <div class="leaves-list">
        <h3 class="mb-4">‚è≥ Pending Leave Requests</h3>
        
        {% if pending_requests %}
          {% for request in pending_requests %}
          <div class="leave-card pending" data-request-id="{{request.request_id}}">
            <div class="leave-header-info">
              <div class="leave-title">{{request.student_name}} - Request #{{request.request_id}}</div>
              <span class="status-badge status-pending">Pending Approval</span>
            </div>
            
            <div class="leave-details">
              <div class="detail-item">
                <i class="fas fa-user"></i>
                <span>Student: {{request.student_name}}</span>
              </div>
              <div class="detail-item">
                <i class="fas fa-home"></i>
                <span>Room: {{request.room}}</span>
              </div>
              <div class="detail-item">
                <i class="fas fa-calendar-alt"></i>
                <span>From: {{request.leave_from}}</span>
              </div>
              <div class="detail-item">
                <i class="fas fa-calendar-check"></i>
                <span>To: {{request.leave_to}}</span>
              </div>
              <div class="detail-item">
                <i class="fas fa-map-marker-alt"></i>
                <span>{{request.destination}}</span>
              </div>
              <div class="detail-item">
                <i class="fas fa-tag"></i>
                <span>{{request.purpose}}</span>
              </div>
              <div class="detail-item">
                <i class="fas fa-phone"></i>
                <span>Emergency: {{request.emergency_contact}}</span>
              </div>
              <div class="detail-item">
                <i class="fas fa-clock"></i>
                <span>Submitted: <span class="format-date">{{request.submitted_at}}</span></span>
              </div>
            </div>
            
            <div class="mt-3 d-flex gap-2">
              <button class="btn btn-success btn-sm" onclick="approveRequest('{{request.request_id}}')">
                <i class="fas fa-check"></i> Approve & Generate QR
              </button>
              <button class="btn btn-danger btn-sm" onclick="rejectRequest('{{request.request_id}}')">
                <i class="fas fa-times"></i> Reject
              </button>
            </div>
          </div>
          {% endfor %}
        {% else %}
          <div class="text-center py-5">
            <i class="fas fa-inbox" style="font-size: 4rem; color: #ccc; margin-bottom: 1rem;"></i>
            <h4>No Pending Requests</h4>
            <p class="text-muted">All leave requests have been processed.</p>
          </div>
        {% endif %}
      </div>

      <!-- All Leave Requests -->
      <div class="leaves-list mt-4">
        <h3 class="mb-4">üìã All Leave Requests</h3>
        
        {% if all_requests %}
          {% for request in all_requests %}
          <div class="leave-card {{request.status.lower().replace(' ', '-')}}">
            <div class="leave-header-info">
              <div class="leave-title">{{request.student_name}} - {{request.request_id}}</div>
              <span class="status-badge status-{{request.status.lower().replace(' ', '-')}}">{{request.status}}</span>
            </div>
            
            <div class="leave-details">
              <div class="detail-item">
                <i class="fas fa-user"></i>
                <span>Student: {{request.student_name}}</span>
              </div>
              <div class="detail-item">
                <i class="fas fa-home"></i>
                <span>Room: {{request.room}}</span>
              </div>
              <div class="detail-item">
                <i class="fas fa-calendar-alt"></i>
                <span>From: {{request.leave_from}}</span>
              </div>
              <div class="detail-item">
                <i class="fas fa-calendar-check"></i>
                <span>To: {{request.leave_to}}</span>
              </div>
              <div class="detail-item">
                <i class="fas fa-map-marker-alt"></i>
                <span>{{request.destination}}</span>
              </div>
              <div class="detail-item">
                <i class="fas fa-tag"></i>
                <span>{{request.purpose}}</span>
              </div>
              {% if request.status == 'Approved' and request.pass_id %}
              <div class="detail-item">
                <i class="fas fa-id-badge"></i>
                <span>Pass ID: {{request.pass_id}}</span>
              </div>
              {% endif %}
              {% if request.approved_by %}
              <div class="detail-item">
                <i class="fas fa-user-check"></i>
                <span>By: {{request.approved_by}}</span>
              </div>
              {% endif %}
            </div>
            
            {% if request.status == 'Approved' and request.qr_code %}
            <div class="mt-3">
              <button class="btn btn-info btn-sm" onclick="showExistingQR('{{request.qr_code}}', '{{request.pass_id}}', '{{request.student_name}}')">
                <i class="fas fa-qrcode"></i> View QR Code
              </button>
            </div>
            {% endif %}
          </div>
          {% endfor %}
        {% else %}
          <div class="text-center py-5">
            <i class="fas fa-list" style="font-size: 4rem; color: #ccc; margin-bottom: 1rem;"></i>
            <h4>No Leave Requests</h4>
            <p class="text-muted">No leave requests have been submitted yet.</p>
          </div>
        {% endif %}
      </div>

      <!-- QR Modal -->
      <div class="qr-modal" id="qrModal">
        <div class="qr-content">
          <button class="qr-close" onclick="closeQRModal()">
            <i class="fas fa-times"></i>
          </button>
          
          <div class="text-center">
            <h3 class="mb-3">‚úàÔ∏è Leave Pass Generated</h3>
            <img id="qrCodeImage" class="qr-code-img" src="" alt="QR Code">
            
            <div id="leaveInfo" class="mt-3">
              <!-- Leave info will be populated by JavaScript -->
            </div>
            
            <div class="mt-3">
              <button class="btn btn-primary me-2" onclick="downloadQR()">
                <i class="fas fa-download"></i>
                Download
              </button>
              <button class="btn btn-success" onclick="printPass()">
                <i class="fas fa-print"></i>
                Print Pass
              </button>
            </div>
          </div>
        </div>
      </div>

      <footer class="footer">
        <p>&copy; 2025 AI Powered Hostel Manager. All rights reserved.</p>
      </footer>
    </main>
  </div>

  <script>
    let currentLeaveData = null;

    // Set minimum date to today
    document.addEventListener('DOMContentLoaded', function() {
      const now = new Date();
      const dateString = now.toISOString().slice(0, 16);
      document.getElementById('leaveFrom').min = dateString;
      document.getElementById('leaveTo').min = dateString;
    });

    // Update minimum "to" date when "from" date changes
    document.getElementById('leaveFrom').addEventListener('change', function() {
      document.getElementById('leaveTo').min = this.value;
    });

    // Approve leave request
    async function approveRequest(requestId) {
      if (!confirm('Are you sure you want to approve this leave request?')) return;
      
      try {
        const response = await fetch(`/qr/approve_leave_request/${requestId}`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          }
        });

        const data = await response.json();

        if (data.success) {
          currentLeaveData = data;
          showQRModal(data);
          
          // Remove the request from pending list
          const requestCard = document.querySelector(`[data-request-id="${requestId}"]`);
          if (requestCard) {
            requestCard.style.opacity = '0.5';
            requestCard.innerHTML = '<div class="text-center p-3"><i class="fas fa-check text-success"></i> Approved Successfully</div>';
          }
          
          // Refresh page after 2 seconds
          setTimeout(() => {
            window.location.reload();
          }, 2000);
        } else {
          alert('Error: ' + data.error);
        }
      } catch (error) {
        alert('Error approving request: ' + error.message);
      }
    }

    // Reject leave request
    async function rejectRequest(requestId) {
      const reason = prompt('Please provide a reason for rejection (optional):');
      if (reason === null) return; // User cancelled
      
      try {
        const response = await fetch(`/qr/reject_leave_request/${requestId}`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({ reason: reason || 'No reason provided' })
        });

        const data = await response.json();

        if (data.success) {
          // Remove the request from pending list
          const requestCard = document.querySelector(`[data-request-id="${requestId}"]`);
          if (requestCard) {
            requestCard.style.opacity = '0.5';
            requestCard.innerHTML = '<div class="text-center p-3"><i class="fas fa-times text-danger"></i> Rejected</div>';
          }
          
          // Refresh page after 2 seconds
          setTimeout(() => {
            window.location.reload();
          }, 2000);
        } else {
          alert('Error: ' + data.error);
        }
      } catch (error) {
        alert('Error rejecting request: ' + error.message);
      }
    }

    // Show existing QR code
    function showExistingQR(qrCode, passId, studentName) {
      const modal = document.getElementById('qrModal');
      const qrImage = document.getElementById('qrCodeImage');
      const leaveInfo = document.getElementById('leaveInfo');

      qrImage.src = qrCode;
      leaveInfo.innerHTML = `
        <div class="alert alert-info">
          <h5>Approved Leave Pass:</h5>
          <p><strong>Student:</strong> ${studentName}</p>
          <p><strong>Pass ID:</strong> ${passId}</p>
          <p><em>This pass has already been approved and QR code generated.</em></p>
        </div>
      `;

      modal.classList.add('show');
    }

    function showQRModal(data) {
      const modal = document.getElementById('qrModal');
      const qrImage = document.getElementById('qrCodeImage');
      const leaveInfo = document.getElementById('leaveInfo');

      // Set QR code image
      qrImage.src = data.qr_code;

      // Set leave info
      leaveInfo.innerHTML = `
        <div class="alert alert-warning">
          <h5>Leave Pass Details:</h5>
          <p><strong>Student:</strong> ${data.leave_data.student_name}</p>
          <p><strong>Pass ID:</strong> ${data.leave_data.pass_id}</p>
          <p><strong>Room:</strong> ${data.leave_data.room}</p>
          <p><strong>Purpose:</strong> ${data.leave_data.purpose}</p>
          <p><strong>Destination:</strong> ${data.leave_data.destination}</p>
          <p><strong>Duration:</strong> ${new Date(data.leave_data.leave_from).toLocaleString()} to ${new Date(data.leave_data.leave_to).toLocaleString()}</p>
        </div>
      `;

      modal.classList.add('show');
    }

    function closeQRModal() {
      document.getElementById('qrModal').classList.remove('show');
    }

    function downloadQR() {
      if (!currentLeaveData) return;

      const link = document.createElement('a');
      link.download = `leave_pass_${currentLeaveData.leave_data.pass_id}.png`;
      link.href = currentLeaveData.qr_code;
      link.click();
    }

    function printPass() {
      if (!currentLeaveData) return;

      const printContent = `
        <html>
          <head>
            <title>Leave Pass</title>
            <style>
              body { font-family: Arial, sans-serif; padding: 20px; text-align: center; }
              .pass { border: 2px solid #ffc107; padding: 20px; margin: 20px auto; max-width: 400px; }
              .qr-code { margin: 20px 0; }
              .qr-code img { width: 200px; height: 200px; }
            </style>
          </head>
          <body>
            <div class="pass">
              <h2>DIGITAL LEAVE PASS</h2>
              <p><strong>Student:</strong> ${currentLeaveData.leave_data.student_name}</p>
              <p><strong>Pass ID:</strong> ${currentLeaveData.leave_data.pass_id}</p>
              <p><strong>Room:</strong> ${currentLeaveData.leave_data.room}</p>
              <p><strong>Purpose:</strong> ${currentLeaveData.leave_data.purpose}</p>
              <p><strong>Destination:</strong> ${currentLeaveData.leave_data.destination}</p>
              <p><strong>Valid From:</strong> ${new Date(currentLeaveData.leave_data.leave_from).toLocaleString()}</p>
              <p><strong>Valid To:</strong> ${new Date(currentLeaveData.leave_data.leave_to).toLocaleString()}</p>
              <div class="qr-code">
                <img src="${currentLeaveData.qr_code}" alt="QR Code">
              </div>
            </div>
          </body>
        </html>
      `;

      const printWindow = window.open('', '_blank');
      printWindow.document.write(printContent);
      printWindow.document.close();
      printWindow.print();
    }

    // Close modal when clicking outside
    document.getElementById('qrModal').addEventListener('click', function(e) {
      if (e.target === this) {
        closeQRModal();
      }
    });

    // Format dates on page load
    document.addEventListener('DOMContentLoaded', function() {
      const dateElements = document.querySelectorAll('.format-date');
      dateElements.forEach(element => {
        const dateStr = element.textContent;
        if (dateStr) {
          try {
            const date = new Date(dateStr);
            element.textContent = date.toLocaleString();
          } catch (e) {
            // Keep original if parsing fails
          }
        }
      });
    });
  </script>
</body>
</html>